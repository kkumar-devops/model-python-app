{{- if .Values.externalSecrets.enabled }}
{{- if .Values.externalSecrets.createSecretStore }}
---
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: {{ include "clinical-ai-prefect.fullname" . }}-vault-store
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "clinical-ai-prefect.name" . }}
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.vault.server | quote }}
      path: {{ .Values.externalSecrets.vault.path | default "secret" | quote }}
      version: {{ .Values.externalSecrets.vault.version | default "v2" | quote }}
      auth:
        kubernetes:
          mountPath: {{ .Values.externalSecrets.vault.auth.mountPath | default "kubernetes" | quote }}
          role: {{ .Values.externalSecrets.vault.auth.role | quote }}
          serviceAccountRef:
            name: {{ .Values.serviceAccount.name }}
{{- end }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.secrets.database.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "clinical-ai-prefect.name" . }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "60s" | quote }}
  secretStoreRef:
    {{- if .Values.externalSecrets.createSecretStore }}
    name: {{ include "clinical-ai-prefect.fullname" . }}-vault-store
    kind: SecretStore
    {{- else }}
    name: {{ .Values.externalSecrets.clusterSecretStore | default "vault-rcc" }}
    kind: ClusterSecretStore
    {{- end }}
  target:
    name: {{ .Values.secrets.database.name }}
  data:
    # Database Connection URLs
    - secretKey: {{ .Values.secrets.database.keys.databaseUrl }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: database-url
    - secretKey: {{ .Values.secrets.database.keys.prefectDatabaseUrl }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: prefect-database-url
    
    # MinIO Credentials (development only)
    - secretKey: {{ .Values.secrets.database.keys.minioAccessKey }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: minio-access-key
    - secretKey: {{ .Values.secrets.database.keys.minioSecretKey }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: minio-secret-key
{{- if and (eq .Values.config.storageEnvironment "production") (not .Values.secrets.aws.useIamRole) }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.secrets.aws.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "clinical-ai-prefect.name" . }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "60s" | quote }}
  secretStoreRef:
    {{- if .Values.externalSecrets.createSecretStore }}
    name: {{ include "clinical-ai-prefect.fullname" . }}-vault-store
    kind: SecretStore
    {{- else }}
    name: {{ .Values.externalSecrets.clusterSecretStore | default "vault-rcc" }}
    kind: ClusterSecretStore
    {{- end }}
  target:
    name: {{ .Values.secrets.aws.name }}
  data:
    # AWS S3 Credentials (if using IAM roles, these may not be needed)
    - secretKey: {{ .Values.secrets.aws.keys.accessKeyId }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: aws-access-key-id
    - secretKey: {{ .Values.secrets.aws.keys.secretAccessKey }}
      remoteRef:
        key: {{ .Values.externalSecrets.vault.secretPath | quote }}
        property: aws-secret-access-key
{{- end }}
{{- else if .Values.secrets.database.data }}
# Fallback: Create Kubernetes Secret directly if external secrets disabled
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.secrets.database.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "clinical-ai-prefect.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{ .Values.secrets.database.keys.databaseUrl }}: {{ index .Values.secrets.database.data .Values.secrets.database.keys.databaseUrl | quote }}
  {{ .Values.secrets.database.keys.prefectDatabaseUrl }}: {{ index .Values.secrets.database.data .Values.secrets.database.keys.prefectDatabaseUrl | quote }}
  {{ .Values.secrets.database.keys.minioAccessKey }}: {{ index .Values.secrets.database.data .Values.secrets.database.keys.minioAccessKey | quote }}
  {{ .Values.secrets.database.keys.minioSecretKey }}: {{ index .Values.secrets.database.data .Values.secrets.database.keys.minioSecretKey | quote }}
{{- end }}

